# =============================================================================
# vcluster Kubeconfig Extraction Reference
# =============================================================================
#
# This document describes how the GovKloud platform extracts kubeconfig
# credentials from vcluster instances for workbench (code-server) pods.
#
# Each lab session creates an isolated vcluster instance within its own
# namespace. The workbench pod needs a kubeconfig to interact with the
# vcluster's Kubernetes API.
#
# APPROACH: kubectl-based extraction from vcluster's auto-created secret
# REASON: The `vcluster connect --print` CLI command hangs in non-interactive
#         PHP exec() contexts (no TTY). Extracting directly from the K8s
#         secret is faster and more reliable.
# =============================================================================

# --- Step 1: vcluster creates these resources automatically ---
# When a vcluster is installed via Helm, it creates a secret containing
# the admin kubeconfig for that vcluster instance.

vcluster_secret:
  # Secret naming convention: vc-vc-{release_name}
  # Example: if release_name = "vc-abc12345"
  #          then secret name = "vc-vc-abc12345"
  name_pattern: "vc-vc-{release_name}"
  namespace: "{host_namespace}"  # e.g., gk-sess-abc12345
  type: Opaque
  keys:
    - certificate-authority  # CA cert for the vcluster API server
    - client-certificate     # Client cert for admin access
    - client-key            # Client private key
    - config                # Full kubeconfig YAML (base64 encoded in secret)
    - token                 # Service account token

# --- Step 2: Extract kubeconfig from the secret ---
# The 'config' key contains a full kubeconfig YAML.
# It can be extracted with:

extraction_command: |
  kubectl get secret vc-vc-{release_name} \
    --namespace {host_namespace} \
    --kubeconfig {kubeconfig_path} \
    -o jsonpath='{.data.config}' | base64 -d

# --- Step 3: Rewrite the server URL ---
# The extracted kubeconfig has server: https://localhost:8443
# This must be rewritten to the vcluster's ClusterIP service URL
# so the workbench pod can reach it within the cluster network.

url_rewrite:
  original: "https://localhost:8443"
  replacement: "https://{release_name}.{host_namespace}:443"
  # Example: https://vc-abc12345.gk-sess-abc12345:443
  # This resolves to the vcluster's ClusterIP service via K8s DNS

# --- Step 4: Store as a new secret ---
# The rewritten kubeconfig is stored as a new secret in the same namespace
# for the workbench pod to mount.

stored_secret:
  name: "vcluster-kubeconfig"
  namespace: "{host_namespace}"
  key: "config"
  # The workbench pod mounts this at /home/coder/.kube/config

# --- Security Notes ---
# - Each user gets their own namespace + vcluster (full isolation)
# - The kubeconfig is scoped to ONE vcluster (no cross-tenant access)
# - Users interact with their vcluster API, never the host cluster
# - Secrets are namespace-scoped (users can't read other namespaces)

# --- Per-User Isolation Flow ---
# User A -> gk-sess-aaa -> vc-aaa (own vcluster) -> workbench-a (own code-server)
# User B -> gk-sess-bbb -> vc-bbb (own vcluster) -> workbench-b (own code-server)
